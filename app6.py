# –æ–±—â–∞—è —Ç–∞–±–ª–∏—Ü–∞
import streamlit as st
import pandas as pd
from sqlalchemy import create_engine, text
from io import BytesIO

st.set_page_config(page_title="–≠–∫—Å–ø–æ—Ä—Ç ‚Äî —Å–≤–æ–¥–Ω—ã–π Excel", layout="wide")
st.title("–û–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã–π —ç–∫—Å–ø–æ—Ä—Ç–Ω—ã–π –æ—Ç—á—ë—Ç")

# --- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ ---
engine = create_engine("postgresql://user:password@localhost:5432/ktzh")

# =====================================================================
# 1) –ó–∞—è–≤–ª–µ–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–Ω—ã–µ –ø–ª–∞–Ω—ã (3-–∏ —Å—Ç—Ä–∞–Ω—ã)
# =====================================================================
sql1 = text("""
WITH base AS (
    SELECT
        "–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–Ω–∞—è –≥—Ä—É–ø–ø–∞" AS group_name,
        DATE_TRUNC('month', "–î–∞—Ç–∞ –ø–æ–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–ª–µ–Ω–æ") AS month,
        SUM("–ö-–≤–æ –≤–∞–≥–æ–Ω–æ–≤ –∑–∞—è–≤–ª–µ–Ω–æ") AS wagon_sum,
        SUM("–ö-–≤–æ —Ç–æ–Ω–Ω –∑–∞—è–≤–ª–µ–Ω–æ") AS tonn_sum
    FROM shipments
    GROUP BY 1,2
)
SELECT
    group_name,
    TO_CHAR(month, 'Mon YYYY') AS month_label,
    wagon_sum,
    tonn_sum
FROM base
ORDER BY group_name, month_label
""")

df1_raw = pd.read_sql(sql1, engine)

pivot_df1 = df1_raw.pivot_table(
    index="group_name",
    columns="month_label",
    values=["wagon_sum", "tonn_sum"],
    aggfunc="sum"
)

month_order = sorted(
    df1_raw["month_label"].unique(),
    key=lambda x: pd.to_datetime(x, format="%b %Y")
)
pivot_df1 = pivot_df1.reindex(month_order, level=1, axis=1)

df1 = pd.concat(
    [pivot_df1, pd.DataFrame(pivot_df1.sum()).T.rename(index={0: "–ò–¢–û–ì–û"})]
)

# =====================================================================
# 2) –≠–∫—Å–ø–æ—Ä—Ç —á–µ—Ä–µ–∑ –ú–ì–°–ü  (–ò–°–ü–†–ê–í–õ–ï–ù–û)
# =====================================================================
sql2 = text("""
SELECT
    "–í—ã—Ö–æ–¥–Ω–æ–π —Å—Ç—ã–∫ –ö–ó–•",
    "–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–Ω–∞—è –≥—Ä—É–ø–ø–∞",
    "–î–∞—Ç–∞ –ø–æ–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–ª–µ–Ω–æ",
    "–ö-–≤–æ –≤–∞–≥–æ–Ω–æ–≤ –∑–∞—è–≤–ª–µ–Ω–æ",
    "–ö-–≤–æ —Ç–æ–Ω–Ω –∑–∞—è–≤–ª–µ–Ω–æ"
FROM shipments
""")

df2_raw = pd.read_sql(sql2, engine)
df2_raw["–î–∞—Ç–∞ –ø–æ–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–ª–µ–Ω–æ"] = pd.to_datetime(
    df2_raw["–î–∞—Ç–∞ –ø–æ–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–ª–µ–Ω–æ"], errors="coerce"
)

month_names = {
    1:"–Ø–Ω–≤–∞—Ä—å",2:"–§–µ–≤—Ä–∞–ª—å",3:"–ú–∞—Ä—Ç",4:"–ê–ø—Ä–µ–ª—å",5:"–ú–∞–π",6:"–ò—é–Ω—å",
    7:"–ò—é–ª—å",8:"–ê–≤–≥—É—Å—Ç",9:"–°–µ–Ω—Ç—è–±—Ä—å",10:"–û–∫—Ç—è–±—Ä—å",11:"–ù–æ—è–±—Ä—å",12:"–î–µ–∫–∞–±—Ä—å"
}

df2_raw["month_label"] = (
    df2_raw["–î–∞—Ç–∞ –ø–æ–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–ª–µ–Ω–æ"].dt.month.map(month_names) + " " +
    df2_raw["–î–∞—Ç–∞ –ø–æ–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–ª–µ–Ω–æ"].dt.year.astype(str) + "–≥."
)

agg_df2 = df2_raw.groupby(
    ["–í—ã—Ö–æ–¥–Ω–æ–π —Å—Ç—ã–∫ –ö–ó–•", "–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–Ω–∞—è –≥—Ä—É–ø–ø–∞", "month_label"],
    as_index=False
).agg({
    "–ö-–≤–æ –≤–∞–≥–æ–Ω–æ–≤ –∑–∞—è–≤–ª–µ–Ω–æ": "sum",
    "–ö-–≤–æ —Ç–æ–Ω–Ω –∑–∞—è–≤–ª–µ–Ω–æ": "sum"
})

df2 = agg_df2.pivot_table(
    index=["–í—ã—Ö–æ–¥–Ω–æ–π —Å—Ç—ã–∫ –ö–ó–•", "–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–Ω–∞—è –≥—Ä—É–ø–ø–∞"],
    columns="month_label",
    values=["–ö-–≤–æ –≤–∞–≥–æ–Ω–æ–≤ –∑–∞—è–≤–ª–µ–Ω–æ", "–ö-–≤–æ —Ç–æ–Ω–Ω –∑–∞—è–≤–ª–µ–Ω–æ"],
    aggfunc="sum"
).reset_index()

df2.columns = [
    f"{c[0]} ({c[1]})" if isinstance(c, tuple) else c
    for c in df2.columns
]

# =====================================================================
# 3) –£–≥–æ–ª—å
# =====================================================================
sql3 = text("""
SELECT
    "–ù–û–î",
    "–°—Ç–∞–Ω—Ü–∏—è –ø–æ–≥—Ä—É–∑–∫–∏",
    "–ù–æ–º–µ—Ä –ø–ª–∞–Ω–∞",
    "–ì—Ä—É–∑–æ–æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å",
    "–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –≥—Ä—É–∑–∞ (–ï–¢–°–ù–ì)",
    "–°—Ç—Ä–∞–Ω–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è",
    "–í—ã—Ö–æ–¥–Ω–æ–π —Å—Ç—ã–∫ –ö–ó–•",
    "–ö-–≤–æ –≤–∞–≥–æ–Ω–æ–≤ –∑–∞—è–≤–ª–µ–Ω–æ" AS "–í–∞–≥–æ–Ω",
    "–ö-–≤–æ —Ç–æ–Ω–Ω –∑–∞—è–≤–ª–µ–Ω–æ" AS "–¢–æ–Ω–Ω"
FROM shipments
WHERE "–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –≥—Ä—É–∑–∞ (–ï–¢–°–ù–ì)" ILIKE '%—É–≥–æ–ª—å%'
""")

df3 = pd.read_sql(sql3, engine)

if not df3.empty:
    df3.loc[len(df3)] = [
        "–ò–¢–û–ì–û","","","","","","",
        df3["–í–∞–≥–æ–Ω"].sum(),
        df3["–¢–æ–Ω–Ω"].sum()
    ]

# =====================================================================
# 4) –Ø—á–º–µ–Ω—å —á–µ—Ä–µ–∑ –ê–∫—Ç–∞—É
# =====================================================================
sql4 = text("""
SELECT
    "–ù–û–î",
    "–°—Ç–∞–Ω—Ü–∏—è –ø–æ–≥—Ä—É–∑–∫–∏",
    "–ù–æ–º–µ—Ä –ø–ª–∞–Ω–∞",
    "–ì—Ä—É–∑–æ–æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å",
    "–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –≥—Ä—É–∑–∞ (–ï–¢–°–ù–ì)",
    "–°—Ç—Ä–∞–Ω–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è",
    "–í—ã—Ö–æ–¥–Ω–æ–π —Å—Ç—ã–∫ –ö–ó–•",
    "–ö-–≤–æ –≤–∞–≥–æ–Ω–æ–≤ –∑–∞—è–≤–ª–µ–Ω–æ" AS "–í–∞–≥–æ–Ω",
    "–ö-–≤–æ —Ç–æ–Ω–Ω –∑–∞—è–≤–ª–µ–Ω–æ" AS "–¢–æ–Ω–Ω"
FROM shipments
WHERE
    "–í—ã—Ö–æ–¥–Ω–æ–π —Å—Ç—ã–∫ –ö–ó–•" = '–ê–∫—Ç–∞—É-–ü–æ—Ä—Ç (–ø–µ—Ä–µ–≤., —ç–∫—Å–ø.)'
    AND "–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –≥—Ä—É–∑–∞ (–ï–¢–°–ù–ì)" ILIKE '%–Ø—á–º–µ–Ω—å%'
""")

df4 = pd.read_sql(sql4, engine)

if not df4.empty:
    df4.loc[len(df4)] = [
        "–ò–¢–û–ì–û","","","","","","",
        df4["–í–∞–≥–æ–Ω"].sum(),
        df4["–¢–æ–Ω–Ω"].sum()
    ]

# =====================================================================
# 5) –í–°–ï –ì–†–£–ó–´ —á–µ—Ä–µ–∑ –ø–æ—Ä—Ç—ã (–∫—Ä–æ–º–µ –ê–∫—Ç–∞—É + –Ø—á–º–µ–Ω—å)
# =====================================================================
sql5 = text("""
SELECT
    "–ù–û–î",
    "–°—Ç–∞–Ω—Ü–∏—è –ø–æ–≥—Ä—É–∑–∫–∏",
    "–ù–æ–º–µ—Ä –ø–ª–∞–Ω–∞",
    "–ì—Ä—É–∑–æ–æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å",
    "–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –≥—Ä—É–∑–∞ (–ï–¢–°–ù–ì)",
    "–°—Ç—Ä–∞–Ω–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è",
    "–í—ã—Ö–æ–¥–Ω–æ–π —Å—Ç—ã–∫ –ö–ó–•",
    "–ö-–≤–æ –≤–∞–≥–æ–Ω–æ–≤ –∑–∞—è–≤–ª–µ–Ω–æ" AS "–í–∞–≥–æ–Ω",
    "–ö-–≤–æ —Ç–æ–Ω–Ω –∑–∞—è–≤–ª–µ–Ω–æ" AS "–¢–æ–Ω–Ω"
FROM shipments
WHERE
    "–í—ã—Ö–æ–¥–Ω–æ–π —Å—Ç—ã–∫ –ö–ó–•" IN (
        '–ê–∫—Ç–∞—É-–ü–æ—Ä—Ç (–ø–µ—Ä–µ–≤., —ç–∫—Å–ø.)',
        '–ö—É—Ä—ã–∫-–ü–æ—Ä—Ç (—ç–∫—Å–ø., –ø–∞—Ä–æ–º)',
        '–ö—É—Ä—ã–∫-–ü–æ—Ä—Ç (—ç–∫—Å–ø., –ø–µ—Ä–µ–≤.)'
    )
    AND NOT (
        "–í—ã—Ö–æ–¥–Ω–æ–π —Å—Ç—ã–∫ –ö–ó–•" = '–ê–∫—Ç–∞—É-–ü–æ—Ä—Ç (–ø–µ—Ä–µ–≤., —ç–∫—Å–ø.)'
        AND "–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –≥—Ä—É–∑–∞ (–ï–¢–°–ù–ì)" ILIKE '%–Ø—á–º–µ–Ω—å%'
    )
""")

df5 = pd.read_sql(sql5, engine)

if not df5.empty:
    df5.loc[len(df5)] = [
        "–ò–¢–û–ì–û","","","","","","",
        df5["–í–∞–≥–æ–Ω"].sum(),
        df5["–¢–æ–Ω–Ω"].sum()
    ]

# =====================================================================
# –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï
# =====================================================================
st.header("1Ô∏è‚É£ –ü–ª–∞–Ω—ã 3 —Å—Ç—Ä–∞–Ω—ã"); st.dataframe(df1, use_container_width=True)
st.header("2Ô∏è‚É£ –≠–∫—Å–ø–æ—Ä—Ç —á–µ—Ä–µ–∑ –ú–ì–°–ü"); st.dataframe(df2, use_container_width=True)
st.header("3Ô∏è‚É£ –£–≥–æ–ª—å"); st.dataframe(df3, use_container_width=True)
st.header("4Ô∏è‚É£ –Ø—á–º–µ–Ω—å —á–µ—Ä–µ–∑ –ê–∫—Ç–∞—É"); st.dataframe(df4, use_container_width=True)
st.header("5Ô∏è‚É£ –í—Å–µ –≥—Ä—É–∑—ã —á–µ—Ä–µ–∑ –ø–æ—Ä—Ç—ã (–∫—Ä–æ–º–µ –ê–∫—Ç–∞—É + –Ø—á–º–µ–Ω—å)"); st.dataframe(df5, use_container_width=True)

# =====================================================================
# EXCEL
# =====================================================================
buffer = BytesIO()
with pd.ExcelWriter(buffer, engine="openpyxl") as writer:
    df1.to_excel(writer, sheet_name="–ü–ª–∞–Ω—ã 3 —Å—Ç—Ä–∞–Ω—ã")
    df2.to_excel(writer, sheet_name="–ú–ì–°–ü", index=False)
    df3.to_excel(writer, sheet_name="–£–≥–æ–ª—å", index=False)
    df4.to_excel(writer, sheet_name="–Ø—á–º–µ–Ω—å –ê–∫—Ç–∞—É", index=False)
    df5.to_excel(writer, sheet_name="–í—Å–µ –≥—Ä—É–∑—ã –ø–æ—Ä—Ç—ã", index=False)

st.download_button(
    "üì• –°–∫–∞—á–∞—Ç—å Excel",
    buffer.getvalue(),
    file_name="export_result.xlsx",
    mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
)
