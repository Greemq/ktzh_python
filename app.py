import streamlit as st
import pandas as pd
from sqlalchemy import create_engine

# --- 1. Настройки подключения ---
# Убедись, что пароль и логин такие же, как в docker-compose.yml
DB_URL = "postgresql://user:password@localhost:5432/ktzh"
engine = create_engine(DB_URL)
table_name = "shipments"

st.title("Загрузка данных в БД КТЖ")

# Твой маппинг (копируем как есть)
column_mapping = {
    "НОД": "НОД", "Станция погрузки": "Станция погрузки", "Номер плана": "Номер плана",
    "Номер реестра": "Номер реестра", "Номер строки плана": "Номер строки плана",
    "Грузоотправитель": "Грузоотправитель", "Ветвевладелец": "Ветвевладелец",
    "Наименование груза (ЕТСНГ)": "Наименование груза (ЕТСНГ)", "Номенклатурная группа": "Номенклатурная группа",
    "Код груза ЕТСНГ": "Код груза ЕТСНГ", "Код груза ГНГ": "Код груза ГНГ",
    "Станция назначения": "Станция назначения", "Дорога назначения": "Дорога назначения",
    "Территориальное подразделение": "Территориальное подразделение", "Страна назначения": "Страна назначения",
    "Выходной стык КЗХ": "Выходной стык КЗХ", "Грузополучатель": "Грузополучатель",
    "Экспедитор КЗХ": "Экспедитор КЗХ", "Экспедитор РЖД": "Экспедитор РЖД",
    "Экспедитор дор. наз.": "Экспедитор дор. наз.", "Род вагона": "Род вагона",
    "Код рода вагона": "Код рода вагона", "Принадлежность подвижного соcтава": "Принадлежность подвижного состава",
    "Собственник вагонов": "Собственник вагонов", "Код страны собственника п/ с": "Код страны собственника п/с",
    "К-во вагонов заявлено (без отоз. и откл)": "К-во вагонов заявлено",
    "К-во тонн заявлено (без отоз. и откл)": "К-во тонн заявлено",
    "Количество вагонов Все заявленные (без отозванных и отклоненных)": "Количество вагонов Все заявленные",
    "Количество тонн Все заявленные (без отозванных и отклоненных)": "Количество тонн Все заявленные",
    "Выходные стыки всех причастных ЖА": "Выходные стыки всех причастных ЖА",
    "Дата подачи заявки": "Дата подачи заявки", "Дата погрузки заявлено": "Дата погрузки заявлено",
    "Дата погрузки": "Дата погрузки", "Вид строки в файле": "Вид строки в файле",
    "Признак перевозки (идентификатор в файле)": "Признак перевозки",
    "Наименование получателя в порту": "Наименование получателя в порту", "Наименование порта": "Наименование порта",
    "Примечание из АСУ ДКР (дополнения и коментарии)": "Примечание из АСУ ДКР",
    "Примечание из АСУ ДКР (коментарии из строк ГУ-12)": "Примечание из АСУ ДКР ГУ-12",
    "Примечание из файла": "Примечание из файла", "Причина отказа (примечание при согласовании)": "Причина отказа",
    "Статус заявки": "Статус заявки", "Статус строки  заявки": "Статус строки заявки",
    "Кем утверждена заявка": "Кем утверждена заявка", "Дата утверждения заявки": "Дата утверждения заявки",
    "Номер телеграммы": "Номер телеграммы", "Месяц погрузки": "Месяц погрузки",
    "Количество контейнеров": "Количество контейнеров", "Длина, футов": "Длина, футов",
    "Принадлежность": "Принадлежность", "Условный код и наименование": "Условный код и наименование",
    "К-во вагон/конт. факт": "К-во вагон/конт. факт", "К-во тонн факт": "К-во тонн факт",
    "Кол-во отказанных вагонов": "Кол-во отказанных вагонов", "Кол-во отказанных тонн": "Кол-во отказанных тонн"
}

uploaded = st.file_uploader("Загрузите Excel файл", type=["xlsx"])

if uploaded:
    # Читаем данные (пропускаем 4 строки заголовка КТЖ)
    df = pd.read_excel(uploaded, sheet_name="Report", skiprows=4)
    
    # Убираем пробелы в названиях колонок Excel
    df.columns = [str(c).strip() for c in df.columns]

    if st.button("ЗАЛИТЬ В БАЗУ"):
        try:
            with st.spinner('Заливаем...'):
                # 1. Переименовываем колонки по словарю
                df_pg = df.rename(columns=column_mapping)
                
                # 2. Оставляем только те колонки, которые есть в базе (из маппинга)
                target_cols = list(column_mapping.values())
                existing_cols = [c for c in target_cols if c in df_pg.columns]
                df_pg = df_pg[existing_cols]

                # 3. Удаляем пустые строки (бывают в конце Excel)
                df_pg = df_pg.dropna(how='all')

                # 4. Исправляем даты, чтобы Postgres их понял
                date_cols = ["Дата подачи заявки", "Дата погрузки", "Дата утверждения заявки"]
                for col in date_cols:
                    if col in df_pg.columns:
                        df_pg[col] = pd.to_datetime(df_pg[col], errors='coerce')

                # 5. Сама заливка
                # if_exists='replace' — создаст таблицу заново, если её нет, или перезапишет.
                df_pg.to_sql(table_name, engine, if_exists='replace', index=False)
                
                st.success(f"Готово! Залито {len(df_pg)} строк.")
        except Exception as e:
            st.error(f"Ошибка: {e}")

# Проверка
if st.button("Сколько строк в базе?"):
    try:
        count = pd.read_sql(f"SELECT COUNT(*) FROM {table_name}", engine).iloc[0, 0]
        st.write(f"В базе сейчас: **{count}** записей.")
    except:
        st.error("Таблицы еще нет.")